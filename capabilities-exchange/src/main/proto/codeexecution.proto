syntax = "proto3";

import "google/protobuf/timestamp.proto";

option java_multiple_files = true;
option java_package = "ai.wanaku.core.exchange.v1";
option java_outer_classname = "CodeExecutionExchange";

package ai.wanaku.codeexecution.v1;

/**
 * The code execution service definition.
 * Provides capabilities for executing code in various languages and engine types.
 */
service CodeExecutor {
  /**
   * Executes code and streams the results back to the client.
   * The stream will automatically close when execution completes.
   */
  rpc ExecuteCode (CodeExecutionRequest) returns (stream CodeExecutionReply) {}
}

/**
 * The code execution request message.
 * Contains the code to execute along with optional execution parameters.
 */
message CodeExecutionRequest {
  /**
   * The URI identifying the code execution capability.
   * Format: code-execution-engine://${engine-type}/${language}
   */
  string uri = 1;

  /**
   * The request body content.
   */
  string body = 2;

  /**
   * The source code to execute as a text blob.
   * This field contains the actual code that will be executed by the engine.
   */
  string code = 3;

  /**
   * Optional map of execution arguments.
   * These are command-line arguments or parameters passed to the code execution.
   * Key-value pairs where both key and value are strings.
   */
  map<string, string> arguments = 4;

  /**
   * Optional URI reference to configuration data.
   * Used to provide additional configuration for the execution environment.
   */
  string configuration_uri = 5;

  /**
   * Optional URI reference to secrets data.
   * Used to provide secure credentials or sensitive data needed for execution.
   */
  string secrets_uri = 6;

  /**
   * Optional timeout in milliseconds.
   * Maximum time allowed for code execution before termination.
   * If not specified, a default timeout will be applied.
   */
  optional int64 timeout = 7;

  /**
   * Optional map of environment variables.
   * These environment variables will be set in the execution context.
   */
  map<string, string> environment = 8;
}

/**
 * The code execution reply message.
 * Streamed back to the client during and after code execution.
 * Multiple messages may be sent for a single execution request.
 */
message CodeExecutionReply {
  reserved 1;
  reserved "isError";

  /**
   * The execution output content.
   * For standard output, this contains the stdout data.
   * For errors, this contains the stderr data or error messages.
   * Multiple content strings may be provided for chunked output.
   */
  repeated string content = 2;

  /**
   * The type of output this reply represents.
   * Indicates whether this is stdout, stderr, or a status message.
   */
  OutputType output_type = 3;

  /**
   * The current execution status.
   * Indicates the state of the code execution task.
   */
  ExecutionStatus status = 4;

  /**
   * Optional exit code from the executed process.
   * Only present in the final message when execution completes.
   * A value of 0 typically indicates successful execution.
   */
  optional int32 exit_code = 5;

  /**
   * Optional timestamp when this output was generated.
   */
  google.protobuf.Timestamp timestamp = 6;
}

/**
 * Enumeration of output types for code execution replies.
 */
enum OutputType {
  /**
   * Unspecified output type.
   */
  OUTPUT_TYPE_UNSPECIFIED = 0;

  /**
   * Standard output (stdout) from the executed code.
   */
  OUTPUT_TYPE_STDOUT = 1;

  /**
   * Standard error (stderr) from the executed code.
   */
  OUTPUT_TYPE_STDERR = 2;

  /**
   * Status or informational message about execution progress.
   */
  OUTPUT_TYPE_STATUS = 3;

  /**
   * Final completion message indicating execution has finished.
   */
  OUTPUT_TYPE_COMPLETION = 4;
}

/**
 * Enumeration of execution status values.
 */
enum ExecutionStatus {
  /**
   * Unspecified execution status.
   */
  EXECUTION_STATUS_UNSPECIFIED = 0;

  /**
   * Execution is pending and has not yet started.
   */
  EXECUTION_STATUS_PENDING = 1;

  /**
   * Code is currently being executed.
   */
  EXECUTION_STATUS_RUNNING = 2;

  /**
   * Execution completed successfully.
   */
  EXECUTION_STATUS_COMPLETED = 3;

  /**
   * Execution failed with an error.
   */
  EXECUTION_STATUS_FAILED = 4;

  /**
   * Execution was cancelled by the client.
   */
  EXECUTION_STATUS_CANCELLED = 5;

  /**
   * Execution exceeded the timeout limit.
   */
  EXECUTION_STATUS_TIMEOUT = 6;
}
